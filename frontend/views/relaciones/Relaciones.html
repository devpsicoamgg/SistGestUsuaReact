//<script type="text/jsx">

const obtenerContratos = (setContractData) => {
  notificacionObteniendoDatos("Obteniendo la información de contratos desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const contratos = JSON.parse(res);
        contratos.sort((a, b) => (a.nombreDelContrato > b.nombreDelContrato) ? 1 : -1);
        setContractData(contratos);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarContratos();
};

const obtenerRRHH = (setRrhhData) => {
  notificacionObteniendoDatos("Obteniendo lista de RRHH desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const rrhh = JSON.parse(res);
        rrhh.sort((a, b) => (a.nombreCompleto > b.nombreCompleto) ? 1 : -1);
        setRrhhData(rrhh);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarRRHH();
};

const obtenerGrupos = (setGruposData) => {
  notificacionObteniendoDatos("Obteniendo lista de grupos desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const grupos = JSON.parse(res);
        grupos.sort((a, b) => (a.nombreGrupo > b.nombreGrupo) ? 1 : -1);
        setGruposData(grupos);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarGrupos();
};

function Relaciones() {
  const [contractData, setContractData] = useState([]);
  const [gruposData, setGruposData] = useState([]);
  const [rrhhData, setRrhhData] = useState([]);
  const [filteredGruposData, setFilteredGruposData] = useState([]);
  const [filteredGruposDataCoordinador, setFilteredGruposDataCoordinador] = useState([]);
  const [filteredRRHHData, setFilteredRRHHData] = useState([]);
  const [selectedContracts, setSelectedContracts] = useState({});
  const [selectedRRHH, setSelectedRRHH] = useState({});
  const [searchTextGrupos, setSearchTextGrupos] = useState('');
  const [searchTextrrhh, setSearchTextrrhh] = useState('');
  const [searchTextDosrrhh, setSearchTextDosrrhh] = useState('');
  const history = useHistory();
  const Tooltip = window.antd.Tooltip;
  const { Panel } = Collapse;
  const { Option } = window.antd.Select;

  useEffect(() => {
    obtenerContratos(setContractData);
    obtenerRRHH((data) => {
      setRrhhData(data);
    });
    obtenerGrupos((data) => {
      setGruposData(data);
      setFilteredGruposData(data);
      setFilteredGruposDataCoordinador(data);
      setFilteredRRHHData(data); 
    });
  }, []);

  const formatFecha = (fecha) => {
    const date = new Date(fecha);
    const day = String(date.getDate()).padStart(2, '0');
    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };

  const handleSearchGrupos = (value) => {
    setSearchTextGrupos(value);
    if (value === '') {
      setFilteredGruposData(gruposData);
    } else {
      const filteredGrupos = gruposData.filter(grupo =>
        grupo.groupName.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredGruposData(filteredGrupos);
    }
  };

  const handleSearchRRHH = (value) => {
    setSearchTextrrhh(value);
    if (value === '') {
      setFilteredGruposDataCoordinador(gruposData);
    } else {
      const filteredGruposCoordinador = gruposData.filter(grupo =>
        grupo.groupName.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredGruposDataCoordinador(filteredGruposCoordinador);
    }
  };

  const handleSearchRRHHDos = (value) => {
    setSearchTextDosrrhh(value);
    if (value === '') {
      setFilteredRRHHData(rrhhData);
    } else {
      const filteredRRHH = rrhhData.filter(rrhh =>
        rrhh.nombreCompleto.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredRRHHData(filteredRRHH);
    }
  };

  const handleContractSelect = (groupId, value) => {
    setSelectedContracts(prevState => ({
      ...prevState,
      [groupId]: value
    }));
  };

  const handleRRHHSelect = (index, value) => {
    setSelectedRRHH(prevSelected => {
      const updatedSelected = [...prevSelected];
      updatedSelected[index] = value;
      return updatedSelected;
    });
  };

  const handleActualizarGrupoClick = (grupoId, contratoId) => {
    const contrato = contractData.find(contract => contract.id === contratoId);
    if (!contrato) {
      console.error('Contrato no encontrado');
      return;
    }
    const notificacionMensaje = `Guardando el contrato número ${contrato.contractNumber} - ${contrato.nombreDelContrato}`;
    notificacionGuardando(notificacionMensaje);
    const datosActualizados = {
      contractId: contratoId,
      contratoGrupoMunicipio: `${contrato.contractNumber} - ${contrato.nombreDelContrato}`
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };

  const handleActualizarRRHHClick = (grupoId, coordinadorId, coordinadorNombre) => {
    notificacionGuardando("Actualizando grupo con la coordinación de: " + coordinadorNombre);
    const datosActualizados = {
      coordinadorId: coordinadorId,
      coordinadorNombre: coordinadorNombre,
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };

  const handleActualizarRRHHClickDos = (grupoId, coordinadorId, coordinadorNombre) => {
    notificacionGuardando("Actualizando grupo con el colaborador " + coordinadorNombre);
    const datosActualizados = {
      colaboradorId: coordinadorId,
      colaboradorNombre: coordinadorNombre,
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };

  const gruposColumns = [
    {
      title: 'Nombre del Grupo',
      dataIndex: 'groupName',
      key: 'groupName',
      render: (text, record) => (
        <Tooltip title={record.groupName}>
          <span>{record.groupName}</span>
        </Tooltip>
      ),
    },
    {
      title: 'Municipio del Grupo',
      dataIndex: 'municipality',
      key: 'municipality',
      render: (text, record) => (
        <Tooltip title={record.municipality}>
          <span>{record.municipality}</span>
        </Tooltip>
      ),
    },
    {
      title: 'Actualización Contrato',
      key: 'actualizarContrato',
      render: (text, record) => (
        <div>
          <Select
            placeholder="Selecciona un contrato"
            style={{ width: 240 }}
            onChange={(value) => handleContractSelect(record.id, value)}
          >
            {contractData.map(contract => (
              <Option key={contract.id} value={contract.id}>
                {contract.contractNumber} - {contract.nombreDelContrato}
              </Option>
            ))}
          </Select>
          <button
            className="btn btn-primary"
            onClick={() => handleActualizarGrupoClick(record.id, selectedContracts[record.id])}
          >
            Actualizar Grupo
          </button>
        </div>
      ),
    },
    {
      title: 'Actualización RRHH Coordinador',
      key: 'actualizarRRHH',
      render: (text, record) => (
        <div>
          <Select
            placeholder="Selecciona un RRHH"
            style={{ width: 240 }}
            onChange={(value) => handleRRHHSelect(record.id, value)}
          >
            {rrhhData.map(rrhh => (
              <Option key={rrhh.id} value={rrhh.id}>
                {rrhh.nombreCompleto}
              </Option>
            ))}
          </Select>
          <button
            className="btn btn-primary"
            onClick={() => handleActualizarRRHHClick(record.id, selectedRRHH[record.id], rrhhData.find(rrhh => rrhh.id === selectedRRHH[record.id]).nombreCompleto)}
          >
            Actualizar Grupo
          </button>
        </div>
      ),
    },
    {
      title: 'Actualización RRHH Colaborador',
      key: 'actualizarRRHHDos',
      render: (text, record) => (
        <div>
          <Select
            placeholder="Selecciona un RRHH"
            style={{ width: 240 }}
            onChange={(value) => handleRRHHSelect(record.id, value)}
          >
            {rrhhData.map(rrhh => (
              <Option key={rrhh.id} value={rrhh.id}>
                {rrhh.nombreCompleto}
              </Option>
            ))}
          </Select>
          <button
            className="btn btn-primary"
            onClick={() => handleActualizarRRHHClickDos(record.id, selectedRRHH[record.id], rrhhData.find(rrhh => rrhh.id === selectedRRHH[record.id]).nombreCompleto)}
          >
            Actualizar Grupo
          </button>
        </div>
      ),
    }
  ];

  return (
    <div className="row">
      <div className="col">
        <input
          type="text"
          className="form-control mb-3"
          placeholder="Buscar grupo..."
          value={searchTextGrupos}
          onChange={(e) => handleSearchGrupos(e.target.value)}
        />
        <table className="table table-striped table-hover">
          <thead>
            <tr>
              <th>Nombre del Grupo</th>
              <th>Municipio del Grupo</th>
              <th>Actualización Contrato</th>
              <th>Actualización RRHH Coordinador</th>
              <th>Actualización RRHH Colaborador</th>
            </tr>
          </thead>
          <tbody>
            {filteredGruposData.map(grupo => (
              <tr key={grupo.id}>
                <td>{grupo.groupName}</td>
                <td>{grupo.municipality}</td>
                <td>
                  <Select
                    placeholder="Selecciona un contrato"
                    style={{ width: 240 }}
                    onChange={(value) => handleContractSelect(grupo.id, value)}
                  >
                    {contractData.map(contract => (
                      <Option key={contract.id} value={contract.id}>
                        {contract.contractNumber} - {contract.nombreDelContrato}
                      </Option>
                    ))}
                  </Select>
                  <button
                    className="btn btn-primary"
                    onClick={() => handleActualizarGrupoClick(grupo.id, selectedContracts[grupo.id])}
                  >
                    Actualizar Grupo
                  </button>
                </td>
                <td>
                  <Select
                    placeholder="Selecciona un RRHH"
                    style={{ width: 240 }}
                    onChange={(value) => handleRRHHSelect(grupo.id, value)}
                  >
                    {rrhhData.map(rrhh => (
                      <Option key={rrhh.id} value={rrhh.id}>
                        {rrhh.nombreCompleto}
                      </Option>
                    ))}
                  </Select>
                  <button
                    className="btn btn-primary"
                    onClick={() => handleActualizarRRHHClick(grupo.id, selectedRRHH[grupo.id], rrhhData.find(rrhh => rrhh.id === selectedRRHH[grupo.id]).nombreCompleto)}
                  >
                    Actualizar Grupo
                  </button>
                </td>
                <td>
                  <Select
                    placeholder="Selecciona un RRHH"
                    style={{ width: 240 }}
                    onChange={(value) => handleRRHHSelect(grupo.id, value)}
                  >
                    {rrhhData.map(rrhh => (
                      <Option key={rrhh.id} value={rrhh.id}>
                        {rrhh.nombreCompleto}
                      </Option>
                    ))}
                  </Select>
                  <button
                    className="btn btn-primary"
                    onClick={() => handleActualizarRRHHClickDos(grupo.id, selectedRRHH[grupo.id], rrhhData.find(rrhh => rrhh.id === selectedRRHH[grupo.id]).nombreCompleto)}
                  >
                    Actualizar Grupo
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
//</script>