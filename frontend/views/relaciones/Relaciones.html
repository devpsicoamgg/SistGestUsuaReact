//<script type="text/jsx">

const useFetchData = (fetchFunction, parseData, setData) => {
  useEffect(() => {
    const fetchData = async () => {
      try {
        notificacionObteniendoDatos("Obteniendo datos desde el servidor");
        const res = await google.script.run.withSuccessHandler();
        const data = JSON.parse(res);
        const sortedData = data.sort((a, b) => (parseData(a) > parseData(b) ? 1 : -1));
        setData(sortedData);
      } catch (error) {
        console.error('Error parsing JSON:', error);
      } finally {
        Swal.close();
      }
    };

    fetchData();
  }, [fetchFunction, parseData, setData]);
};

const formatFecha = (fecha) => {
  const date = new Date(fecha);
  const day = String(date.getDate()).padStart(2, '0');
  const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const month = monthNames[date.getMonth()];
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
};

function Relaciones() {
  const [contractData, setContractData] = useState([]);
  const [gruposData, setGruposData] = useState([]);
  const [rrhhData, setRrhhData] = useState([]);
  const [searchTextContract, setSearchTextContract] = useState('');
  const [searchTextGrupos, setSearchTextGrupos] = useState('');
  const [searchTextrrhh, setSearchTextrrhh] = useState('');
  const history = useHistory();
  const Tooltip = window.antd.Tooltip;

  useFetchData(() => google.script.run.listarContratos(), data => data.nombreDelContrato, setContractData);
  useFetchData(() => google.script.run.listarRRHH(), data => data.nombreCompleto, setRrhhData);
  useFetchData(() => google.script.run.listarGrupos(), data => data.nombreGrupo, setGruposData);

  const handleSearch = (setSearchText, setData, originalData, value) => {
    setSearchText(value);
    if (value === '') {
      setData(originalData);
    } else {
      const filteredData = originalData.filter(item => 
        item.name.toLowerCase().includes(value.toLowerCase())
      );
      setData(filteredData);
    }
  };

  const contractColumns = [
    {
      title: 'Nombre del Contrato',
      dataIndex: 'nombreDelContrato',
      key: 'nombreDelContrato',
    },
    {
      title: 'N√∫mero del Contrato',
      dataIndex: 'contractNumber',
      key: 'contractNumber',
    },
    {
      title: 'Fecha Creaci√≥n',
      dataIndex: 'fechaCreacion',
      key: 'fechaCreacion',
      render: (text, record) => formatFecha(record.fechaCreacion),
    },
    {
      title: 'Acciones',
      key: 'acciones',
      render: (text, record) => (
        <div>
          {/* Aqu√≠ se pueden agregar acciones espec√≠ficas para contratos */}
        </div>
      ),
    },
  ];

  const gruposColumns = [
    {
      title: 'Nombre del Grupo',
      dataIndex: 'nombreGrupo',
      key: 'nombreGrupo',
    },
    {
      title: 'Fecha de Creaci√≥n',
      dataIndex: 'fechaCreacion',
      key: 'fechaCreacion',
      render: (text, record) => formatFecha(record.fechaCreacion),
    },
    {
      title: 'C√≥digo Cuentame',
      dataIndex: 'cuentameCode',
      key: 'cuentameCode',
    },
    {
      title: 'Acciones',
      key: 'acciones',
      render: (text, record) => (
        <div>
          {/* Aqu√≠ se pueden agregar acciones espec√≠ficas para grupos */}
        </div>
      ),
    },
  ];

  const rrhhColumns = [
    {
      title: 'Nombre Completo',
      dataIndex: 'nombreCompleto',
      key: 'nombreCompleto',
    },
    {
      title: 'Cargo',
      dataIndex: 'cargo',
      key: 'cargo',
    },
    {
      title: 'Acciones',
      key: 'acciones',
      render: (text, record) => (
        <div>
          {/* Aqu√≠ se pueden agregar acciones espec√≠ficas para RRHH */}
        </div>
      ),
    },
  ];

  return (
    <div className="flex flex-col items-center justify-center p-4 bg-gray-100 min-h-screen">
      <h2 className="font-bold text-2xl mb-4">ZONA DE RELACIONES</h2>
      <div className="w-full max-w-screen-lg flex flex-col gap-4">
        <Card 
          title="Contratos" 
          className="rounded" 
          extra={
            <Tooltip title="Buscar Contrato">
              <Input.Search
                placeholder="Buscar por nombre de contrato ‚úçüèΩ"
                value={searchTextContract}
                onChange={e => handleSearch(setSearchTextContract, setContractData, contractData, e.target.value)}
                className="flex-1 p-2 rounded border border-gray-300"
              />
            </Tooltip>
          }
        >
          <Table
            columns={contractColumns}
            dataSource={contractData.map((contract, index) => ({ ...contract, key: index }))}
            pagination={{ pageSize: 3 }}
          />
        </Card>

        <Card 
          title="Grupos" 
          className="rounded" 
          extra={
            <Tooltip title="Buscar Grupo">
              <Input.Search
                placeholder="Buscar por nombre de grupo ‚úçüèΩ"
                value={searchTextGrupos}
                onChange={e => handleSearch(setSearchTextGrupos, setGruposData, gruposData, e.target.value)}
                className="flex-1 p-2 rounded border border-gray-300"
              />
            </Tooltip>
          }
        >
          <Table
            columns={gruposColumns}
            dataSource={gruposData.map((grupo, index) => ({ ...grupo, key: index }))}
            pagination={{ pageSize: 3 }}
          />
        </Card>

        <Card 
          title="Talento Humano (RRHH)" 
          className="rounded" 
          extra={
            <Tooltip title="Buscar RRHH">
              <Input.Search
                placeholder="Buscar por nombre ‚úçüèΩ"
                value={searchTextrrhh}
                onChange={e => handleSearch(setSearchTextrrhh, setRrhhData, rrhhData, e.target.value)}
                className="flex-1 p-2 rounded border border-gray-300"
              />
            </Tooltip>
          }
        >
          <Table
            columns={rrhhColumns}
            dataSource={rrhhData.map((rrhh, index) => ({ ...rrhh, key: index }))}
            pagination={{ pageSize: 3 }}
          />
        </Card>
      </div>
    </div>
  );
};


//</script>
