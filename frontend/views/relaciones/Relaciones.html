//<script type="text/jsx">

const obtenerContratos = (setContractData) => {
  notificacionObteniendoDatos("Obteniendo la informaci√≥n de contratos desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const contratos = JSON.parse(res);
        contratos.sort((a, b) => (a.nombreDelContrato > b.nombreDelContrato) ? 1 : -1);
        setContractData(contratos);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarContratos();
};

const obtenerRRHH = (setRrhhData) => {
  notificacionObteniendoDatos("Obteniendo lista de RRHH desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const rrhh = JSON.parse(res);
        rrhh.sort((a, b) => (a.nombreCompleto > b.nombreCompleto) ? 1 : -1);
        setRrhhData(rrhh);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarRRHH();
};

const obtenerGrupos = (setGruposData) => {
  notificacionObteniendoDatos("Obteniendo lista de grupos desde el servidor");
  google.script.run
    .withSuccessHandler(res => {
      try {
        const grupos = JSON.parse(res);
        grupos.sort((a, b) => (a.nombreGrupo > b.nombreGrupo) ? 1 : -1);
        setGruposData(grupos);
        Swal.close();
      } catch (error) {
        console.error('Error parsing JSON:', error);
        Swal.close();
      }
    })
    .listarGrupos();
};

function Relaciones() {
  const [contractData, setContractData] = useState([]);
  const [gruposData, setGruposData] = useState([]);
  const [rrhhData, setRrhhData] = useState([]);
  const [filteredGruposData, setFilteredGruposData] = useState([]);
  const [filteredGruposDataCoordinador, setFilteredGruposDataCoordinador] = useState([]);
  const [filteredRRHHData, setFilteredRRHHData] = useState([]);
  const [selectedContracts, setSelectedContracts] = useState({});
  const [selectedCoordinators, setSelectedCoordinators] = useState({});
  const [selectedRRHH, setSelectedRRHH] = useState({});
  const [searchTextGrupos, setSearchTextGrupos] = useState('');
  const [searchTextrrhh, setSearchTextrrhh] = useState('');
  const [searchTextDosrrhh, setSearchTextDosrrhh] = useState('');
  const history = useHistory();
  const Tooltip = window.antd.Tooltip;
  const { Panel } = Collapse;
  const { Option } = window.antd.Select;

  useEffect(() => {
    obtenerContratos(setContractData);
    obtenerRRHH((data) => {
      setRrhhData(data);
    });
    obtenerGrupos((data) => {
      setGruposData(data);
      setFilteredGruposData(data);
      setFilteredGruposDataCoordinador(data);
      setFilteredRRHHData(data); 
    });
  }, []);

  const formatFecha = (fecha) => {
    const date = new Date(fecha);
    const day = String(date.getDate()).padStart(2, '0');
    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };


  const handleSearchGrupos = (value) => {
    setSearchTextGrupos(value);
    if (value === '') {
      setFilteredGruposData(gruposData);
    } else {
      const filteredGrupos = gruposData.filter(grupo =>
        grupo.groupName.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredGruposData(filteredGrupos);
    }
  };

  const handleSearchRRHH = (value) => {
    setSearchTextrrhh(value);
    if (value === '') {
      setFilteredGruposDataCoordinador(gruposData);
    } else {
      const filteredGruposCoordinador = gruposData.filter(grupo =>
        grupo.groupName.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredGruposDataCoordinador(filteredGruposCoordinador);
    }
  };

  const handleSearchRRHHDos = (value) => {
    setSearchTextDosrrhh(value);
    if (value === '') {
      setFilteredRRHHData(rrhhData);
    } else {
      const filteredRRHH = rrhhData.filter(rrhh =>
        rrhh.nombreCompleto.toLowerCase().includes(value.toLowerCase())
      );
      setFilteredRRHHData(filteredRRHH);
    }
  };
  
  const handleContractSelect = (groupId, value) => {
    setSelectedContracts(prevState => ({
      ...prevState,
      [groupId]: value
    }));
  };

  const handleCoordinatorChange = (recordId, coordinatorId) => {
    setSelectedCoordinators(prevState => ({
      ...prevState,
      [recordId]: coordinatorId,
    }));
  };

  const handleRRHHSelect = (index, value) => {
    setSelectedRRHH(prevSelected => {
      const updatedSelected = [...prevSelected];
      updatedSelected[index] = value;
      return updatedSelected;
    });
  };

  const handleActualizarGrupoClick = (grupoId, contratoId) => {
    const contrato = contractData.find(contract => contract.id === contratoId);
    if (!contrato) {
      console.error('Contrato no encontrado');
      return;
    }
    const notificacionMensaje = `Guardando el contrato n√∫mero ${contrato.contractNumber} - ${contrato.nombreDelContrato}`;
    notificacionGuardando(notificacionMensaje);
    const datosActualizados = {
      contractId: contratoId,
      contratoGrupoMunicipio: `${contrato.contractNumber} - ${contrato.nombreDelContrato}`
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };


  const handleActualizarRRHHClick = (grupoId, coordinadorId, coordinadorNombre) => {
    notificacionGuardando("Actualizando grupo con coordinador/a " + coordinadorNombre);
    const datosActualizados = {
      coordinadorId: coordinadorId,
      coordinadorNombre: coordinadorNombre,
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };

  const handleActualizarRRHHClickDos = (grupoId, coordinadorId, coordinadorNombre) => {
    notificacionGuardando("Actualizando grupo con el colaborador " + coordinadorNombre);
    const datosActualizados = {
      colaboradorId: coordinadorId,
      colaboradorNombre: coordinadorNombre,
    };
    google.script.run.withSuccessHandler(response => {
      console.log('Respuesta del servidor:', response);
      Swal.fire({
        title: response.titulo,
        text: response.descripcion,
        icon: response.icono || 'info',
        timer: 2000,
        timerProgressBar: true
      });
    })
    .withFailureHandler(error => {
      console.error('Error al actualizar grupo:', error);
      Swal.fire({
        title: 'Ops ha ocurrido un error!',
        text: 'Por favor contacte a soporte.',
        icon: 'error'
      });
    })
    .actualizarGrupo(grupoId, JSON.stringify(datosActualizados));
  };



  

  const gruposColumns = [
    {
      title: 'Nombre del Grupo',
      dataIndex: 'groupName',
      key: 'groupName',
      render: (text, record) => (
        <Tooltip title={record.groupName}>
        <span>{record.groupName}</span>
        </Tooltip>
        ),
      },
    {
      title: 'Fecha de Creaci√≥n',
      dataIndex: 'fechaCreacion',
      key: 'fechaCreacion',
      render: (text, record) => formatFecha(record.fechaCreacion),
    },
    {
      title: 'C√≥digo Cuentame',
      dataIndex: 'cuentameCode',
      key: 'cuentameCode',
    },
    {
      title: 'Contrato',
      key: 'contractInfo',
      render: (text, record) => {
        const contrato = record.contractId ? contractData.find(contract => contract.id === record.contractId) : null;
        const isEditable = selectedContracts[record.id] !== undefined;
        const selectedValue = isEditable ? selectedContracts[record.id] : (contrato ? contrato.id : undefined);
        const tooltipText = contrato
        ? `El contrato asociado al grupo es ${contrato.contractNumber} - ${contrato.nombreDelContrato}`
          : 'Se debe asociar el grupo a un contrato';
        const tooltipColor = contrato ? 'green' : 'red';
  
        return (
          <div>
            <Tooltip title={tooltipText} color={tooltipColor}>
              <Select
                placeholder="Seleccionar contrato üìÑ"
                style={{ width: 200 }}
                onChange={value => handleContractSelect(record.id, value)}
                value={selectedValue}
                disabled={contrato && !isEditable}
              >
                {contractData.map(contract => (
                  <Select.Option key={contract.id} value={contract.id}>
                    {`${contract.contractNumber} - ${contract.nombreDelContrato}`}
                  </Select.Option>
                ))}
              </Select>
            </Tooltip>
            {contrato ? (
              <Tooltip title={tooltipText} color={tooltipColor}>
              <Button
                type="primary"
                onClick={() => {
                  if (isEditable) {
                    handleActualizarGrupoClick(record.id, selectedContracts[record.id]);
                  } else {
                    setSelectedContracts(prevState => ({
                      ...prevState,
                      [record.id]: record.contractId
                    }));
                  }
                }}
                style={{ marginTop: 8, backgroundColor: isEditable ? '#1890ff' : '#fff', color: isEditable ? '#fff' : '#000' }}
              >
                {isEditable ? 'Actualizar Grupo' : 'Editar'}
              </Button>
              </Tooltip>
            ) : (
              <Button
                type="primary"
                onClick={() => handleActualizarGrupoClick(record.id, selectedContracts[record.id])}
                style={{ marginTop: 8, backgroundColor: '#1890ff', color: '#fff' }}
                disabled={!selectedContracts[record.id]}
              >
                Actualizar Grupo
              </Button>
            )}
          </div>
        );
      },
    },
  ];
  
  const coordinadoresColumns = [
    {
      title: 'Nombre del Grupo',
      dataIndex: 'groupName',
      key: 'groupName',
    },
    {
      title: 'C√≥digo Cuentame',
      dataIndex: 'cuentameCode',
      key: 'cuentameCode',
    },
    {
      title: 'Contrato Asociado',
      dataIndex: 'contratoGrupoMunicipio',
      key: 'contratoGrupoMunicipio',
      render: (text, record) => (
        record.contratoGrupoMunicipio ? record.contratoGrupoMunicipio : '(Sin contrato asociado)'
      ),
    },
    {
      title: 'Coordinador',
      key: 'acciones',
      render: (text, record) => {
        // Filtrar los coordinadores del estado rrhhData aplicando un filter.
        const coordinadores = rrhhData.filter(rrhh => rrhh.cargo === 'Coordinador/a');
        // Encontrar el coordinador seleccionado para el registro actual
        const selectedCoordinator = coordinadores.find(coordinador => coordinador.id === record.coordinatorId);
        // Determinar si hay un coordinador seleccionado
        const hasCoordinator = Boolean(selectedCoordinator);
        // Determinar si se puede editar el coordinador (condiciones espec√≠ficas seg√∫n tu l√≥gica)
        const isEditable = record.estado === 'Activo' && hasCoordinator; // Por ejemplo, solo editable si el estado es 'Activo'
    
        // Texto y color para el tooltip
        const tooltipText = hasCoordinator
          ? `El coordinador asignado es ${selectedCoordinator.nombreCompleto}`
          : 'Se debe seleccionar un coordinador para este registro';
        const tooltipColor = hasCoordinator ? 'green' : 'red';
    
        // Funci√≥n para manejar el click en el bot√≥n Agregar/Editar
        const handleAgregarClick = () => {
          // Validar cualquier condici√≥n necesaria antes de realizar la acci√≥n
          if (!record.contratoId) { // Por ejemplo, verificar si existe un contrato asociado
            Swal.fire({
              title: 'Error',
              text: 'Primero debe asociar este registro a un contrato.',
              icon: 'error'
            });
            return;
          }
    
          // Llamar a la funci√≥n para actualizar el coordinador
          handleActualizarRRHHClick(record.id, selectedCoordinator ? selectedCoordinator.id : null);
        };
    
        // Funci√≥n para manejar la selecci√≥n de un coordinador/a
        const handleCoordinatorSelect = (value) => {
          handleCoordinatorChange(record.id, value); // Suponiendo que tengas una funci√≥n para actualizar el estado localmente
        };
    
        return (
          <div>
            <Tooltip title={tooltipText} color={tooltipColor}>
              {hasCoordinator ? (
                <p>{selectedCoordinator.nombreCompleto}</p>
              ) : (
                <Select
                  style={{ width: 200, marginRight: 8 }}
                  placeholder="Seleccionar coordinador/a üë∑üèº‚Äç‚ôÇÔ∏è"
                  onChange={handleCoordinatorSelect}
                  value={record.coordinatorId || undefined}
                >
                  {coordinadores.map(coordinador => (
                    <Select.Option key={coordinador.id} value={coordinador.id}>
                      {coordinador.nombreCompleto}
                    </Select.Option>
                  ))}
                </Select>
              )}
            </Tooltip>
            <Button
              type="primary"
              onClick={handleAgregarClick}
              style={{ marginTop: 8, backgroundColor: isEditable ? '#1890ff' : '#fff', color: isEditable ? '#fff' : '#000' }}
              disabled={!isEditable}
            >
              {hasCoordinator ? 'Editar' : 'Agregar'}
            </Button>
          </div>
        );
      },
    }
    
    
  ];
  


  const rrhhColumns = [
    {
      title: 'Nombre del Grupo',
      dataIndex: 'groupName',
      key: 'groupName',
    },
    {
      title: 'C√≥digo Cuentame',
      dataIndex: 'cuentameCode',
      key: 'cuentameCode',
    },
    {
      title: 'Contrato Asociado',
      dataIndex: 'contratoGrupoMunicipio',
      key: 'contratoGrupoMunicipio',
      render: (text, record) => (
        record.contratoGrupoMunicipio ? record.contratoGrupoMunicipio : '(Sin contrato asociado)'
      ),
    },
    {
      title: 'Coordinador/a',
      dataIndex: 'coordinadorNombre',
      key: 'coordinadorNombre',
      render: (text, record) => (
        record.coordinadorNombre ? record.coordinadorNombre : '(Sin coordinador asociado)'
      ),
    },
    {
      title: 'RRHH',
      key: 'acciones',
      render: (text, record, index) => {
        const recursoHumano = rrhhData.filter(rrhh => rrhh.cargo !== 'Coordinador/a');
        const selectedColaborador = recursoHumano.find(colaborador => colaborador.id === selectedRRHH[index]);
  
        const handleAgregarClickDos = () => {
          if (!record.contratoGrupoMunicipio || !record.coordinadorNombre) {
            Swal.fire({
              title: 'Ops ha ocurrido un error!',
              text: 'Primero debe asociar el grupo a un contrato y a un coordinador.',
              icon: 'error'
            });
            return;
          }
  
          handleActualizarRRHHClickDos(record.id, selectedRRHH[index], selectedColaborador.nombreCompleto);
        };
  
        return (
          <div style={{ display: 'flex', alignItems: 'center' }}>
            <Select
              style={{ width: 200, marginRight: 8 }}
              placeholder="Seleccionar colaborador üë∑üèº‚Äç‚ôÇÔ∏è"
              onChange={value => handleRRHHSelect(index, value)}
              value={selectedRRHH[index]}
            >
              {recursoHumano.map(coordinador => (
                <Select.Option key={coordinador.id} value={coordinador.id}>
                  {coordinador.nombreCompleto}
                </Select.Option>
              ))}
            </Select>
            <Button type="primary" onClick={handleAgregarClickDos}>
              Agregar
            </Button>
          </div>
        );
      },
    } 
  ];

  return (
    <div className="flex flex-col items-center justify-center p-4 bg-gray-100 min-h-screen">
      <h2 className="font-bold text-2xl mb-4">ZONA DE RELACIONES</h2>
      <div className="w-full max-w-screen-lg flex flex-col gap-4">
        <Collapse accordion>

        <Panel header="Grupos Vs Contrato" key="1" style={{ backgroundColor: '#ccffcc' }}>
            <Input.Search
              placeholder="Buscar por nombre de grupo ‚úçüèΩ"
              value={searchTextGrupos}
              onChange={e => handleSearchGrupos(e.target.value)}
              className="mb-2 rounded border border-gray-300"
            />
            <Table
              columns={gruposColumns}
              dataSource={filteredGruposData.map((data, index) => ({ ...data, key: index }))}
              pagination={{ pageSize: 3 }}
            />
          </Panel>

        <Panel header="Grupos Vs Coordinador" key="2" style={{ backgroundColor: '#C1DC8F' }}>
            <Input.Search
              placeholder="Buscar por nombre de colaborador ‚úçüèΩ"
              value={searchTextrrhh}
              onChange={e => handleSearchRRHH(e.target.value)}
              className="mb-2 rounded border border-gray-300"
            />
            <Table
              columns={coordinadoresColumns}
              dataSource={filteredGruposDataCoordinador.map((data, index) => ({ ...data, key: index }))}
              pagination={{ pageSize: 3 }}
            />
          </Panel>

          <Panel header="Grupo Vs Docente" key="3" style={{ backgroundColor: '#ccccff' }}>
            <Input.Search
              placeholder="Buscar por nombre ‚úçüèΩ"
              value={searchTextDosrrhh}
              onChange={e => handleSearchRRHHDos(e.target.value)}
              className="mb-2 rounded border border-gray-300"
            />
            <Table
              columns={rrhhColumns}
              dataSource={filteredRRHHData.map((data, index) => ({ ...data, key: index }))}
              pagination={{ pageSize: 3 }}
            />
          </Panel>
        </Collapse>
      </div>
    </div>
  );
}


//</script>